########################################
# 1) Build stage (Maven)
########################################
FROM maven:3.9.8-amazoncorretto-21 AS builder
WORKDIR /app

# Same JVM flags you use in Dev
ENV JAVA_TOOL_OPTIONS="--add-opens=java.base/java.nio=ALL-UNNAMED -Dsnowflake.jdbc.enableArrow=false"

# Copy POM and (if you need it) install your local dialect jar so Maven can resolve it
COPY pom.xml ./
COPY libs/snowflake-hibernate.jar libs/
RUN mvn -q install:install-file \
      -Dfile=libs/snowflake-hibernate.jar \
      -DgroupId=net.snowflake \
      -DartifactId=snowflake-hibernate \
      -Dversion=0.0.2-SNAPSHOT \
      -Dpackaging=jar -DgeneratePom=true || true
RUN mvn -q -B dependency:go-offline

# Copy source and build the fat JAR
COPY src ./src
RUN mvn -q -T 1C clean package -DskipTests

########################################
# 2) Runtime stage (small, non-root)
########################################
FROM amazoncorretto:21-alpine
WORKDIR /app

# non-root user
RUN addgroup -S app && adduser -S app -G app
USER app

# copy jar from builder
COPY --from=builder /app/target/*-SNAPSHOT.jar /app/app.jar

# same JVM flags
ENV JAVA_TOOL_OPTIONS="--add-opens=java.base/java.nio=ALL-UNNAMED -Dsnowflake.jdbc.enableArrow=false"
ENV TZ=Asia/Manila

EXPOSE 8080
ENTRYPOINT ["java","-jar","/app/app.jar"]
# default profile is prod; overrideable via env
ENV SPRING_PROFILES_ACTIVE=prod
